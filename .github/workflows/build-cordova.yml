name: Cordova Build (Debug/Release APK/AAB)

on:
  repository_dispatch:
    types: [trigger-build]

env:
  JAVA_VERSION: '17'
  GRADLE_VERSION: '8.2.0'
  NODE_VERSION: '20'
  ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
  ANDROID_API_LEVEL: '35'         # ubah sesuai kebutuhan target (mis. 33)
  ANDROID_BUILD_TOOLS: '35.0.0'   # ubah jika perlu
  GRADLE_USER_HOME: ${{ runner.temp }}/.gradle

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    timeout-minutes: ${{ github.event.client_payload.timeoutMinutes || 8 }}
    outputs:
      outcome: ${{ steps.final_check.outputs.outcome }}

    steps:
      - name: Record start time
        shell: bash
        run: echo "start_time=$(date +%s)" >> $GITHUB_ENV

      - name: Report Build In Progress
        shell: bash
        run: |
          curl --fail -X POST \
            -H "Content-Type: application/json" \
            -H "X-Build-Secret: ${{ secrets.WEBHOOK_SECRET }}" \
            -d '{
              "buildId": "${{ github.event.client_payload.buildId }}",
              "userId": "${{ github.event.client_payload.userId }}",
              "status": "in_progress"
            }' \
            "${{ github.event.client_payload.internalApiUrl }}/api/github-webhook"

      # ---------- Setup runtime + caches ----------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Setup Java (Temurin) & enable gradle cache
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}
          cache: gradle

      - name: Cache Gradle (caches & wrapper)
        uses: actions/cache@v4
        id: gradle-cache
        with:
          path: |
            ${{ env.GRADLE_USER_HOME }}/caches
            ${{ env.GRADLE_USER_HOME }}/wrapper
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-v${{ env.GRADLE_VERSION }}-${{ hashFiles('**/gradle/wrapper/gradle-wrapper.properties') }}
          restore-keys: |
            gradle-${{ runner.os }}-v${{ env.GRADLE_VERSION }}-
            gradle-${{ runner.os }}-

      - name: Cache Android SDK components
        uses: actions/cache@v4
        id: android-sdk-cache
        with:
          path: |
            ${{ env.ANDROID_SDK_ROOT }}/platforms
            ${{ env.ANDROID_SDK_ROOT }}/build-tools
            ${{ env.ANDROID_SDK_ROOT }}/platform-tools
            ${{ env.ANDROID_SDK_ROOT }}/extras
            ~/.android
          key: android-sdk-${{ runner.os }}-api${{ env.ANDROID_API_LEVEL }}-bt${{ env.ANDROID_BUILD_TOOLS }}
          restore-keys: |
            android-sdk-${{ runner.os }}-

      - name: Cache project node_modules (will be populated after unzip)
        uses: actions/cache@v4
        id: node-modules-cache
        with:
          path: cordova-project/node_modules
          key: node-modules-${{ runner.os }}-${{ hashFiles('cordova-project/package-lock.json', 'cordova-project/package.json') }}
          restore-keys: |
            node-modules-${{ runner.os }}-

      - name: Cache npm global cache
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: npm-cache-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            npm-cache-${{ runner.os }}-

      # ---------- Install Android SDK bits (if missing) ----------
      - name: Ensure Android SDK root exists
        run: |
          sudo mkdir -p "${{ env.ANDROID_SDK_ROOT }}"
          sudo chown -R $USER: "$ANDROID_SDK_ROOT"

      - name: Install required Android SDK components (if missing)
        shell: bash
        run: |
          set -e
          # PATH update to use sdkmanager if present
          export ANDROID_SDK_ROOT=${{ env.ANDROID_SDK_ROOT }}
          export PATH=$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$ANDROID_SDK_ROOT/tools/bin:$PATH

          # If cmdline-tools not present, install latest commandline tools from distro (minimal)
          if [ ! -d "$ANDROID_SDK_ROOT/cmdline-tools/latest" ]; then
            mkdir -p /tmp/cmdline
            cd /tmp/cmdline
            # download commandline tools
            curl -sS -L "https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip" -o cmdline.zip || true
            unzip -q cmdline.zip -d "$ANDROID_SDK_ROOT/cmdline-tools"
            mv "$ANDROID_SDK_ROOT/cmdline-tools/cmdline-tools" "$ANDROID_SDK_ROOT/cmdline-tools/latest" || true
          fi

          yes | sdkmanager --sdk_root="$ANDROID_SDK_ROOT" --licenses >/dev/null || true
          sdkmanager --sdk_root="$ANDROID_SDK_ROOT" "platform-tools" "platforms;android-${{ env.ANDROID_API_LEVEL }}" "build-tools;${{ env.ANDROID_BUILD_TOOLS }}" || true

      # ---------- Prepare build environment ----------
      - name: Install Cordova CLI (global)
        shell: bash
        run: npm install -g cordova

      - name: Download and Unzip Project
        shell: bash
        run: |
          set -e
          ZIP_URL="${{ github.event.client_payload.projectUrl }}"
          echo "Using project URL (internal): $ZIP_URL"
          mkdir -p cordova-project
          curl -L -f -o cordovaProject.zip "$ZIP_URL"
          unzip -q cordovaProject.zip -d cordova-project

      - name: Ensure Gradle wrapper version is locked to 8.2.0 (if project uses wrapper)
        shell: bash
        run: |
          set -e
          cd cordova-project || exit 0
          if [ -f gradlew ]; then
            echo "Updating gradle wrapper to ${GRADLE_VERSION}"
            chmod +x ./gradlew
            ./gradlew wrapper --gradle-version=${GRADLE_VERSION} --distribution-type=all || true
          else
            echo "No gradlew found in project â€” relying on system Gradle (not recommended)."
          fi

      # restore node-modules cache key was declared earlier; now install dependencies
      - name: Install Dependencies and Build Project
        id: cordova_build_step
        shell: bash
        env:
          GRADLE_USER_HOME: ${{ env.GRADLE_USER_HOME }}
          ANDROID_HOME: ${{ env.ANDROID_SDK_ROOT }}
          ANDROID_SDK_ROOT: ${{ env.ANDROID_SDK_ROOT }}
        run: |
          set -e
          # redirect log to top-level for easier upload on failure
          exec &> ../build_log.txt

          cd cordova-project
          echo "--- Node dependencies ---"
          if [ -f package-lock.json ]; then
            npm ci --prefer-offline --no-audit --progress=false
          else
            npm install --prefer-offline --no-audit --progress=false
          fi

          echo "--- Ensure Android platform present ---"
          # If project already has android platform, this will be a no-op
          cordova platform rm android || true
          cordova platform add android@latest --no-fetch

          echo "--- Gradle and Android build configuration ---"
          export GRADLE_OPTS="-Dorg.gradle.daemon=false -Dorg.gradle.jvmargs=-Xmx1536m"
          # Set ANDROID_HOME for gradle/cordova
          export ANDROID_HOME=${{ env.ANDROID_SDK_ROOT }}
          export PATH=$ANDROID_HOME/platform-tools:$PATH

          echo "--- Starting Cordova Build ---"
          if [[ "${{ github.event.client_payload.buildType }}" == "debug-apk" ]]; then
            cordova build android --debug -- --gradleArg=--no-daemon --gradleArg=-Pandroid.useAndroidX=true
          else
            echo "--- Downloading Keystore for Release Build ---"
            KEYSTORE_URL="${{ github.event.client_payload.keystoreUrl }}"
            if [ -z "$KEYSTORE_URL" ]; then
              echo "::error::Missing keystore URL for release build"
              exit 2
            fi
            curl -L -f -o release.jks "$KEYSTORE_URL"

            PACKAGE_TYPE_FLAG=""
            if [[ "${{ github.event.client_payload.buildType }}" == "release-aab" ]]; then
              PACKAGE_TYPE_FLAG="--packageType=bundle"
            fi

            echo "--- Running release build (signed) ---"
            cordova build android --release -- --gradleArg=--no-daemon \
              --keystore="release.jks" \
              --alias="${{ github.event.client_payload.keyAlias }}" \
              --storePassword="${{ github.event.client_payload.keystorePassword }}" \
              --password="${{ github.event.client_payload.keyPassword }}" \
              --gradleArg=-Pandroid.useAndroidX=true \
              $PACKAGE_TYPE_FLAG
          fi
          echo "--- Cordova Build Finished ---"

      # ---------- upload artifact ----------
      - name: Setup SSH for SCP
        if: success()
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Upload Build File via SCP and Report Success
        if: success()
        shell: bash
        run: |
          USER_ID="${{ github.event.client_payload.userId }}"
          BUILD_ID="${{ github.event.client_payload.buildId }}"
          BUILD_TYPE="${{ github.event.client_payload.buildType }}"

          ARTIFACT_PATH=$(find cordova-project/platforms/android/app -name "*.aab" -o -name "*.apk" | head -n 1)
          if [ -z "$ARTIFACT_PATH" ]; then echo "::error::Build artifact not found!"; exit 1; fi

          if [[ "$BUILD_TYPE" == "debug-apk" ]]; then PREFIX="debug"; else PREFIX="release"; fi
          if [[ "$BUILD_TYPE" == "release-aab" ]]; then EXTENSION="aab"; else EXTENSION="apk"; fi
          NEW_FILENAME="${PREFIX}_${BUILD_ID}.${EXTENSION}"

          ssh -o StrictHostKeyChecking=no emi@84.46.248.72 "mkdir -p /home/emi/swaplab-project/apps/cordova-app/public/builds/$USER_ID"
          scp -o StrictHostKeyChecking=no "$ARTIFACT_PATH" emi@84.46.248.72:/home/emi/swaplab-project/apps/cordova-app/public/builds/$USER_ID/$NEW_FILENAME

          DOWNLOAD_URL="${{ github.event.client_payload.publicBaseUrl }}/builds/$USER_ID/$NEW_FILENAME"

          end_time=$(date +%s)
          duration=$((end_time - start_time))

          curl --fail -X POST \
            -H "Content-Type: application/json" \
            -H "X-Build-Secret: ${{ secrets.WEBHOOK_SECRET }}" \
            -d '{
              "buildId": "'"$BUILD_ID"'", "userId": "'"$USER_ID"'",
              "status": "complete", "durationSeconds": "'"$duration"'", "downloadUrl": "'"$DOWNLOAD_URL"'"
            }' \
            "${{ github.event.client_payload.internalApiUrl }}/api/github-webhook"

      - name: Upload Log File and Report Failure
        if: failure()
        shell: bash
        run: |
          INTERNAL_API_URL="${{ github.event.client_payload.internalApiUrl }}"
          if [ -z "$INTERNAL_API_URL" ]; then
             echo "::error::Fatal: internalApiUrl not received in payload. Cannot report failure."
             exit 1
          fi

          USER_ID="${{ github.event.client_payload.userId }}"
          BUILD_ID="${{ github.event.client_payload.buildId }}"

          LOG_FILE_PATH="build_log.txt"
          if [ ! -f "${LOG_FILE_PATH}" ]; then
            echo "Build failed very early. Main log file not found." > ${LOG_FILE_PATH}
          fi

          UPLOAD_RESPONSE=$(curl -s -w "\n%{http_code}" -X POST -F "logFile=@${LOG_FILE_PATH}" -F "buildId=$BUILD_ID" -H "X-Build-Secret: ${{ secrets.WEBHOOK_SECRET }}" "$INTERNAL_API_URL/upload-log/$USER_ID")
          LOG_FILENAME=$(echo "$UPLOAD_RESPONSE" | sed '$d')
          LOG_SNIPPET=$(tail -n 50 ${LOG_FILE_PATH})
          CLEANED_LOG_SNIPPET=$(echo "$LOG_SNIPPET" | sed -E 's|/home/runner/work/[^/]+/[^/]+|[...]|g')
          ESCAPED_LOG_SNIPPET=$(echo "$CLEANED_LOG_SNIPPET" | sed 's/\\/\\\\/g' | sed 's/"/\\"/g' | awk "{printf \"%s\\\\n\", \$0}" | sed 's/$/\\n/' | tr -d '\n')
          end_time=$(date +%s)
          duration=$((end_time - start_time))

          curl --fail -X POST -H "Content-Type: application/json" -H "X-Build-Secret: ${{ secrets.WEBHOOK_SECRET }}" -d '{"buildId": "'"$BUILD_ID"'", "userId": "'"$USER_ID"'","status": "failed", "durationSeconds": "'"$duration"'", "logFile": "'"$LOG_FILENAME"'","logSnippet": "'"$ESCAPED_LOG_SNIPPET"'"}' "$INTERNAL_API_URL/api/github-webhook"

      - name: Final check
        id: final_check
        if: always()
        shell: bash
        run: |
          echo "outcome=${{ job.status }}" >> $GITHUB_OUTPUT
